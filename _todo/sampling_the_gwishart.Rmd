library(Matrix)
library(MASS)
library(rstan)

options(mc.cores = parallel::detectCores() - 1)


n <- 100L
p <- 10L
p_up <- as.integer(p * (p - 1) / 2)
p_up


set.seed(1)
A <- rsparsematrix(p, p, 0.15, rand.x = rnorm)
Lambda <- A %*% t(A) + 0.05 * diag(p)

Sigma <- as.matrix(solve(Lambda))

Y <- MASS::mvrnorm(n, rep(0, p), Sigma)


stan.file <- "./_models/horseshoe_nonparanormals.stan"
cat(readLines(stan.file), sep="\n")

fit <- rstan::stan(
  stan.file,
  iter = 3000,
  warmup = 2000,
  data=list(N=n,
            P=p,
            P_upper=p_up,
            y=Y),
  seed=23,
  #control=list(adapt_delta=0.99, max_treedepth=15)
)
fit

omega <- extract(fit)$omega
omega_diag <- extract(fit)$omega_diag
omega <- apply(omega, 2, mean)
omega_diag <- extract(fit)$omega_diag
omega_diag <- apply(omega_diag, 2, mean)

Omega <- matrix(0, p, p)
Omega[lower.tri(Omega)]  <- omega
Omega <- t(Omega) + Omega
diag(Omega) <-omega_diag
Omega[abs(Omega) < .01] <- 0

as(Omega, "dgCMatrix")
Lambda

